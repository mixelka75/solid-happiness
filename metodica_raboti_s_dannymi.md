# Алгоритм Обработки Данных для Поиска "Золотых Записей"

## Введение

В больших наборах данных часто встречаются дубликаты и "похожие" записи, что затрудняет анализ и принятие решений на их основе. Эти записи могут иметь частично совпадающие или противоречивые данные, а также различаться по полноте и актуальности информации. Наличие таких записей приводит к снижению качества данных и может негативно сказаться на результатах анализа.

**Целью** данной работы является разработка алгоритма, который позволит из множества подобных записей сформировать единую "золотую запись". Эта запись будет содержать наиболее полные, актуальные и достоверные значения полей, что повысит качество данных и упростит их дальнейшую обработку.

## Общий Подход

Алгоритм состоит из нескольких этапов:

1. **Очистка и валидация данных**: Проверка записей на корректность и приведение их к единому формату.
2. **Поиск и объединение дубликатов**: Выявление точных дубликатов на основе ключевых полей и объединение их в одну запись.
3. **Поиск и объединение похожих записей**: Идентификация записей, которые не являются точными дубликатами, но имеют значительную схожесть, и их объединение.
4. **Формирование итогового набора данных**: Объединение результатов предыдущих шагов и сохранение "золотых записей" в выходном файле.

## Шаг 1: Очистка и Валидация Данных

Первоначально данные могут содержать ошибки, некорректные или неполные значения. Чтобы обеспечить корректную работу последующих этапов алгоритма, необходимо провести предварительную очистку и валидацию данных.

### Валидация Записей

Для каждой записи выполняются следующие проверки:

- **Номер телефона**: Проверяется, что номер состоит из 11 цифр, начинается с '7' (после замены '8' на '7'), и не содержит недопустимых символов.
- **Дата рождения**: Проверяется формат даты ('YYYY-MM-DD'), вычисляется возраст (должен быть от 0 до 150 лет), и исключается дата '1900-01-01' как некорректная.
- **Пол**: Допускаются значения 'М', 'Ж', 'M', 'F', а также их полные написания и вариации на русском и английском языках.
- **Email**: Проверяется соответствие стандартному формату email с помощью регулярного выражения.
- **СНИЛС**: Проверяется формат и корректность контрольного числа.
- **ИНН**: Проверяется формат (10 или 12 цифр) и корректность контрольного числа.

Если запись не проходит хотя бы одну из проверок, она исключается из дальнейшей обработки.

### Форматирование Полей

После валидации поля записей приводятся к единому стандарту:

- **Текстовые поля**: Приводятся к нижнему регистру.
- **Полное имя (ФИО)**: Проверяется, что состоит из трех частей (фамилия, имя, отчество).
- **Даты и время**: Проверяется и форматируется в соответствии с шаблонами '%Y-%m-%d' для дат и '%H:%M:%S.%f' для времени.
- **Номера телефонов**: Приводятся к формату без пробелов и дополнительных символов.

Используются функции для проверки и форматирования данных, которые возвращают либо отформатированное значение, либо `None`, если данные некорректны.

## Шаг 2: Поиск и Объединение Дубликатов

На этом этапе алгоритм ищет точные дубликаты записей на основе ключевых полей, которые должны быть уникальными для каждого клиента.

### Ключевые Поля для Поиска Дубликатов

Используются следующие ключевые поля:

- **ИНН (client_inn)**
- **СНИЛС (client_snils)**
- **Email (contact_email)**
- **Номер телефона (contact_phone)**

Если две записи имеют одинаковые значения хотя бы по одному из этих полей, они считаются дубликатами.

### Алгоритм Объединения Дубликатов

Для эффективного объединения дубликатов используется структура данных **Union-Find (Объединение и Поиск)**:

1. **Инициализация**: Каждая запись изначально принадлежит своей собственной группе.
2. **Поиск связей**: Проходим по всем записям и для каждого ключевого поля строим отображение "значение поля" → "список индексов записей с этим значением".
3. **Объединение групп**: Если два или более записей имеют одинаковое значение ключевого поля, их группы объединяются.
4. **Формирование групп дубликатов**: После объединения все записи разделены на группы, где каждая группа представляет собой набор дубликатов.

### Формирование "Золотой Записи" из Дубликатов

Для каждой группы дубликатов создается одна "золотая запись":

- **Объединение полей**: Проходим по всем записям в группе и для каждого поля выбираем наиболее актуальное значение.
- **Актуальность**: Актуальность определяется по полю `update_date`; если у записи более поздняя дата обновления, ее значения полей считаются более актуальными.
- **Заполнение пропущенных данных**: Если в более актуальной записи какое-то поле отсутствует или пустое, берется значение из менее актуальной записи, если оно присутствует.

В результате для каждой группы дубликатов получаем одну объединенную запись с наиболее полными и актуальными данными.

## Шаг 3: Поиск и Объединение Похожих Записей

Похожие записи — это записи, которые не являются точными дубликатами, но имеют высокую степень схожести по определенным полям.

### Построение Блоков

Для сокращения количества попарных сравнений записи группируются в блоки:

- **Ключ блока**: Комбинация нормализованных фамилии, имени и даты рождения.
- **Нормализация**: Убираются пробелы и символы приводятся к нижнему регистру.
- **Результат**: Записи с одинаковым ключом попадают в один блок для дальнейшего сравнения.

### Сравнение Записей в Блоках

Внутри каждого блока записи сравниваются попарно:

- **Поля для сравнения и их веса**:
  - Имя (1)
  - Отчество (1)
  - Фамилия (1)
  - Дата рождения (2)
  - ИНН (2)
  - СНИЛС (2)
  - Номер телефона (1)
  - Email (1)
- **Метрика схожести**: Для каждой пары записей вычисляется процент схожести на основе суммарного веса совпадающих полей.
- **Порог схожести**: Если процент схожести ≥ 60%, записи считаются похожими и объединяются в группу.

### Формирование "Золотой Записи" из Похожих Записей

Аналогично объединению дубликатов:

- **Объединение полей**: Для каждой группы похожих записей создается "золотая запись" путем выбора наиболее актуальных и полных значений полей.
- **Учет актуальности**: При конфликте значений предпочтение отдается данным из записи с более поздней датой обновления.

## Шаг 4: Формирование Итогового Набора Данных

После получения "золотых записей" из дубликатов и похожих записей, необходимо объединить эти результаты:

- **Объединение списков**: Формируется единый список "золотых записей", исключая повторения.
- **Удаление дубликатов**: При объединении списков проверяется уникальность записей по набору всех полей.
- **Запись в файл**: Итоговый набор данных записывается в CSV-файл с заданными полями в определенном порядке.

## Заключение

Разработанный алгоритм позволяет эффективно очищать данные, выявлять дубликаты и похожие записи, и формировать "золотые записи", содержащие наиболее полные и актуальные данные. Это значительно повышает качество данных и упрощает их дальнейшую обработку и анализ.

Преимущества подхода:

- **Улучшение качества данных**: Удаление некорректных и дублирующихся записей снижает шум в данных.
- **Экономия ресурсов**: Автоматическое объединение записей сокращает ручной труд по проверке и корректировке данных.
- **Повышение точности анализа**: Работа с очищенными и консолидированными данными позволяет получать более точные результаты при анализе.

Алгоритм может быть адаптирован и расширен для работы с другими типами данных и полями, а также интегрирован в существующие системы обработки данных.
